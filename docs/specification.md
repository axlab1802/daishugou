# 酔いどれ大富豪 仕様書

## 1. ゲーム基本仕様

### 1.1 ゲーム概要

| 項目 | 内容 |
|------|------|
| ジャンル | カードゲーム（大富豪系） |
| プレイ人数 | 1人（vs CPU） |
| プレイ時間 | 1ゲーム約3〜5分 |
| 勝利条件 | 先に手札を全て出し切る |

### 1.2 ゲームフロー

```
[タイトル画面]
    │
    ├─→ [ルール確認] ─→ [戻る]
    │
    └─→ [ゲーム開始]
            │
            ▼
        [カード配布] ← 各10枚
            │
            ▼
        [先攻決定] ← 水(3)を持つ方
            │
            ▼
    ┌─→ [プレイヤーターン]
    │       │
    │       ├─→ [カード選択] ─→ [カード出し]
    │       │                      │
    │       └─→ [パス] ──────────┤
    │                              │
    │       ▼                      │
    │   [勝利判定] ─→ YES ─→ [結果画面]
    │       │
    │       NO
    │       ▼
    │   [CPUターン]
    │       │
    │       ├─→ [カード出し]
    │       │       │
    │       └─→ [パス]
    │               │
    │       ▼       │
    │   [勝利判定] ─┴─→ YES ─→ [結果画面]
    │       │
    │       NO
    │       │
    └───────┘
```

---

### 1.3 オンライン対戦（2〜6人）

#### 目的
- Vercel にデプロイした Web アプリに、複数のスマホ（2〜6人）から同時参加して対戦できる。
- できるだけシンプルな構成で実現する（まずは WebSocket なし / ポーリング同期）。

#### 前提（最小構成）
- フロント: Next.js（App Router）
- API: Next.js Route Handlers（`/api/*`）
- 状態保存: Vercel KV（Redis）
- 同期方式: 高速ポーリング（例: 300〜1000ms 間隔で state 取得）

#### オンライン対戦の基本コンセプト
- ルーム（部屋）単位でゲームを進行する。
- ルームには `owner`（作成者）と `players`（参加者）がいる。
- ターン制（大富豪）のためリアルタイム厳密同期は不要。状態はサーバー側で一元管理し、クライアントは「操作（出す/パス）」を送信して結果を受け取る。

#### ルーム作成と参加
- ルーム作成時に `roomCode`（6桁英数字でも可、最初は数字のみでOK）を発行。
- 参加者は `roomCode` を入力して参加。
- 参加時に `playerId` を発行してブラウザに保存（LocalStorage 等）。

#### ロビー仕様
- `phase = lobby` の間は参加/退出のみ可能。
- 参加人数が 2〜6 人になったら owner が「開始」できる。
- owner は開始前に以下を設定できる：
  - 人数上限（2〜6）
  - 1ターン制限時間（例: 15秒 / 30秒 / 無制限）

#### ゲーム進行（オンライン）
- ゲーム状態はルームに紐づく `GameState` としてサーバーが保持する。
- 各プレイヤーは自分のターンに `play`（カードを出す）または `pass` を API に送る。
- サーバーは入力を検証し、正当なら状態を更新する。

#### ターン制限（オプション）
- `turnDeadlineAt` を状態に持ち、期限を過ぎた場合は自動で `pass` とする。
- ターン制限が無制限の場合は `turnDeadlineAt = null`。

#### 同期（ポーリング）
- クライアントは `GET /api/rooms/{roomCode}/state` を一定間隔で呼び出し、最新状態を取得する。
- `stateVersion`（インクリメント）を持ち、差分更新が可能な設計にする（まずは全量取得でOK）。

#### 切断・再接続
- `playerId` が同じであれば再接続扱いとし、同じ席に復帰する。
- 一定時間（例: 60秒）応答がないプレイヤーは `disconnected` と表示。
- ゲーム中に抜けた場合は以下いずれか（初期は簡単な方でOK）：
  - A案（簡単）: 抜けたプレイヤーは自動 `pass` 継続（勝敗は残りで進行）
  - B案: 途中抜けは即 `敗北` 扱い

#### 不正防止（最低限）
- 手札・山札・判定（出せるか/勝てるか/革命/コンボ）はサーバーのみが更新する。
- クライアントからは「出したいカードID配列」だけ受け取り、サーバー側の手札と一致するか検証する。

#### API（案）
- `POST /api/rooms` ルーム作成（owner 作成）
- `POST /api/rooms/{roomCode}/join` 参加
- `POST /api/rooms/{roomCode}/leave` 退出
- `POST /api/rooms/{roomCode}/start` ゲーム開始（owner のみ）
- `GET  /api/rooms/{roomCode}/state` 状態取得（ポーリング）
- `POST /api/rooms/{roomCode}/action` アクション送信（play/pass）

#### クライアント表示（オンライン）
- 自分の手札は表向き、他プレイヤーは枚数のみ表示（CPU戦UIの拡張）。
- 場、革命状態、次の手番、残り人数、ログ（直近5件）を表示。

---

## 2. カード仕様

### 2.1 カード一覧

| ランク | トランプ | カード名 | 絵文字 | 強さ | 枚数 |
|--------|----------|----------|--------|------|------|
| 3 | 3 | 水 | 💧 | 1（最弱） | 4枚 |
| 4 | 4 | お茶割り | 🍵 | 2 | 4枚 |
| 5 | 5 | 炭酸割り | 🫧 | 3 | 4枚 |
| 6 | 6 | レモンサワー | 🍋 | 4 | 4枚 |
| 7 | 7 | ビール | 🍺 | 5 | 4枚 |
| 8 | 8 | ハイボール | 🥂 | 6 | 4枚 |
| 9 | 9 | ワイン | 🍷 | 7 | 4枚 |
| 10 | 10 | 日本酒 | 🍶 | 8 | 4枚 |
| 11 | J | 焼酎 | 🫗 | 9 | 4枚 |
| 12 | Q | ウイスキー | 🥃 | 10 | 4枚 |
| 13 | K | テキーラ | 🍸 | 11 | 4枚 |
| 14 | A | スピリタス | 🔥 | 12 | 4枚 |
| 15 | 2 | kiyoshi | 👴 | 13（最強） | 4枚 |

**総カード枚数**: 52枚（トランプ1デッキ相当、ジョーカーなし）

### 2.2 カード配布

- デッキをシャッフル
- 各プレイヤーに10枚ずつ配布
- 残り32枚は山札（使用しない）

### 2.3 先攻決定ルール

1. 水（3）を持っているプレイヤーが先攻
2. 両者が水を持っている場合、ランダムで決定
3. どちらも水を持っていない場合、ランダムで決定

---

## 3. ゲームルール仕様

### 3.1 基本ルール

#### カードの出し方
1. 場が空の場合、任意のカードを1枚以上出せる
2. 場にカードがある場合、以下の条件を満たす必要がある：
   - 場と同じ枚数であること
   - 場より強いカードであること
3. 同じランクのカードは複数枚同時に出せる

#### 強さの判定
- 通常時: ランクの数値が大きいほど強い
- 革命時: ランクの数値が小さいほど強い

#### パス
- カードを出せない、または出したくない場合はパス可能
- 場が空の時（自分が親の時）はパス不可

#### 場流し
- 相手がパスした場合、場が流れて最後にカードを出したプレイヤーが親になる
- 親は任意のカードを出せる

### 3.2 革命ルール

#### 発動条件
- 同じランクのカード4枚を同時に出す

#### 効果
- カードの強さが逆転（水が最強、kiyoshiが最弱になる）
- 次に革命が発動するまで継続

#### 革命返し
- 革命中に再度4枚出しで革命が解除され、通常の強さに戻る

### 3.3 特殊コンボルール

特定の組み合わせで出すと、通常は勝てない相手に勝てる。

| コンボ名 | 必要カード | 勝てる相手 | 説明 |
|----------|------------|------------|------|
| テキーラショット | 🍸🍸 テキーラ×2 | 👴 kiyoshi×1 | 「俺も付き合うわ」 |
| 水攻め | 💧💧💧 水×3 | 🍸 テキーラ×1〜2, 🔥 スピリタス×1〜2 | 「酔い覚ましじゃ」 |
| kiyoshiを寝かす | 💧🍵 水+お茶割り | 👴 kiyoshi×1 | 「そろそろ寝てください」 |
| ちゃんぽん | 🍺🍷 ビール+ワイン | 🍶🍶 日本酒×2, 🫗🫗 焼酎×2 | 「混ぜると危険」 |
| ロック解除 | 🥃💧 ウイスキー+水 | 🥃🥃 ウイスキー×2 | 「水割りの方が飲める」 |
| 〆のお茶 | 🍵🍵🍵🍵 お茶割り×4 | 全てのカード | 「はいはい終電終電」最強 |
| 泥酔コンボ | 🫗🫗🥃 焼酎×2+ウイスキー | 👴👴 kiyoshi×2 | 「限界突破」唯一の対抗手段 |
| 介抱セット | 💧🍵🫧 水+お茶割り+炭酸割り | 🔥 スピリタス×1 | 「もう飲ませられない」 |

#### コンボの優先順位
1. コンボは通常の強さ判定より優先される
2. 場のカードがコンボの「勝てる相手」に該当する場合のみ発動可能
3. 場が空の場合、コンボとして出しても通常のカードとして扱われる

### 3.4 勝敗判定

- 先に手札を全て出し切ったプレイヤーの勝利
- 勝者の称号: **大酒豪**
- 敗者の称号: **酔い潰れ**

---

## 4. CPU（AI）仕様

### 4.1 CPUキャラクター

| 項目 | 内容 |
|------|------|
| 名前 | kiyoshi |
| 絵文字 | 👴 |
| 性格 | 宮城出身、イカとテキーラと政治が好きなおっさん |

### 4.2 AI思考ロジック

#### 基本方針
1. 出せるカードの中から最も弱いカードを優先して出す
2. コンボが使える場合は積極的に使用
3. 強いカード（kiyoshi, スピリタス）は終盤まで温存

#### 出すカードの決定アルゴリズム

```
function decideCPUPlay(hand, field):
    if field is empty:
        return 手札の中で最も弱いカード1枚
    
    possiblePlays = []
    
    // 通常の出し方をリストアップ
    for each rank in hand:
        if canBeat(rank, field) and count(rank) >= field.length:
            possiblePlays.add({cards: rank × field.length, priority: rank})
    
    // コンボをリストアップ
    for each combo in COMBOS:
        if hasCardsFor(combo) and combo.beats(field):
            possiblePlays.add({cards: combo.cards, priority: 100})
    
    if possiblePlays is empty:
        return PASS
    
    // 優先度（弱いカード優先）でソート
    sort(possiblePlays, by: priority, ascending: true)
    return possiblePlays[0]
```

#### 難易度別の調整（将来実装）

| 難易度 | 説明 |
|--------|------|
| 初級 | 完全ランダムに出す |
| 中級 | 弱いカードから出す（現在の実装） |
| 上級 | 手札読み、コンボ温存などの戦略 |

---

## 5. UI仕様

### 5.1 画面構成

```
┌─────────────────────────────────────┐
│            ヘッダー                  │
│        「酔いどれ大富豪」            │
├─────────────────────────────────────┤
│          情報バー                    │
│   [kiyoshi: X枚] [あなた: X枚]      │
│          [🔥革命中]                 │
├─────────────────────────────────────┤
│         相手の手札                   │
│     🎴🎴🎴🎴🎴🎴🎴（裏向き）       │
├─────────────────────────────────────┤
│                                     │
│             場                      │
│         [出されたカード]            │
│                                     │
├─────────────────────────────────────┤
│          メッセージ                 │
│      「あなたのターンです」         │
├─────────────────────────────────────┤
│         自分の手札                  │
│   💧🍵🫧🍋🍺🥂🍷🍶🫗🥃            │
├─────────────────────────────────────┤
│    [出す！]         [パス]         │
└─────────────────────────────────────┘
```

### 5.2 カードデザイン

```
┌─────────┐
│ 7      │  ← ランク表示
│         │
│   🍺   │  ← 絵文字（大）
│         │
│ ビール │  ← カード名
└─────────┘
```

#### カードサイズ
- PC: 70px × 100px
- スマートフォン: 55px × 80px

#### カード色（ランク別グラデーション）

| ランク | 背景色 |
|--------|--------|
| 3 (水) | 水色 #87CEEB → #5F9EA0 |
| 4 (お茶割り) | 緑 #98D8AA → #6BBF85 |
| 5 (炭酸割り) | 薄青 #B8E8FC → #82C8E8 |
| 6 (レモンサワー) | 黄 #FFF176 → #FFEB3B |
| 7 (ビール) | 金 #FFD93D → #F5C400 |
| 8 (ハイボール) | 琥珀 #FFCC80 → #FFB74D |
| 9 (ワイン) | ピンク #E8A0BF → #D67BA0 |
| 10 (日本酒) | 白灰 #C4DFDF → #9FC5C5 |
| 11 (焼酎) | 紫 #ADA2FF → #8B7FD4 |
| 12 (ウイスキー) | 茶 #D4A373 → #B8864A |
| 13 (テキーラ) | 赤 #FF6B6B → #E84545 |
| 14 (スピリタス) | オレンジ赤 #FF5722 → #E64A19 |
| 15 (kiyoshi) | 金 #FFD700 → #FFA500 |

### 5.3 アニメーション仕様

| アニメーション | トリガー | 時間 | 効果 |
|----------------|----------|------|------|
| カードホバー | マウスオーバー | 0.15s | Y軸-8px移動 |
| カード選択 | クリック | 0.15s | Y軸-15px移動、緑枠 |
| カード出し | 出すボタン | 0.3s | 場へ移動 |
| コンボ発動 | コンボ成立時 | 1.5s | 中央にテキスト表示 |
| 革命発動 | 4枚出し時 | 1.5s | 「🔥革命！」表示 |
| ターン表示 | ターン切替時 | 1.5s | フェードイン・アウト |
| コンボヒント | 手札更新時 | 持続 | 虹色グロー |

### 5.4 コンボヒント表示仕様

#### カードのハイライト
- 該当カードに虹色のグローエフェクト
- 右上に💥マーク表示
- アニメーション: 1秒周期でパルス

#### ツールチップ
- 画面下部（手札の上）に固定表示
- 背景: ピンク系グラデーション
- 表示内容: コンボ名 + 効果説明
- 複数コンボ可能時: 「他○個のコンボも可能」

---

## 6. データ構造

### 6.1 カードオブジェクト

```javascript
{
  id: "7-0",           // ランク-インデックス（ユニークID）
  rank: 7,             // ランク（3〜15）
  name: "ビール",       // カード名
  emoji: "🍺",         // 絵文字
}
```

### 6.2 ゲーム状態オブジェクト

```javascript
{
  playerHand: [],      // プレイヤーの手札（カード配列）
  opponentHand: [],    // CPUの手札（カード配列）
  field: [],           // 場のカード（カード配列）
  fieldOwner: null,    // 場の最後の出し手（'player' | 'opponent' | null）
  currentTurn: 'player', // 現在のターン（'player' | 'opponent'）
  selectedCards: [],   // 選択中のカードインデックス
  revolution: false,   // 革命状態
  gameOver: false,     // ゲーム終了フラグ
}
```

### 6.4 オンライン用ルーム状態（サーバー保持）

#### RoomState（KVに保存）

```javascript
{
  roomCode: "483921",
  ownerId: "p_owner",
  createdAt: 1730000000000,
  phase: "lobby" | "playing" | "finished",
  maxPlayers: 6,
  turnTimeLimitSec: 30, // 0 or null で無制限
  stateVersion: 1,

  players: [
    {
      playerId: "p1",
      name: "A",
      joinedAt: 1730000001000,
      disconnected: false,
      lastSeenAt: 1730000009000
    }
  ],

  game: {
    hands: {
      p1: [/* Card[] */],
      p2: [/* Card[] */]
    },
    field: [/* Card[] */],
    fieldOwnerId: null,
    currentTurnPlayerId: "p1",
    revolution: false,
    turnDeadlineAt: 1730000030000, // epoch ms, 無制限なら null
    gameOver: false,
    ranking: [] // 上がり順に playerId を追加
  },

  log: [
    { at: 1730000005000, text: "Aが🍺を出した" }
  ]
}
```

#### KVキー設計（案）
- `room:{roomCode}` -> RoomState(JSON)
- `room:{roomCode}:lock` -> 排他制御用（短TTL、SETNX）

#### 排他制御（重要）
- 同時アクセスで状態が壊れないよう、`action` 処理ではロックを取ってから更新する。
- ロック取得に失敗したら短い待ち/リトライ、または 409 を返す。

---

## 7. エラーハンドリング

| 状況 | 処理 |
|------|------|
| 出せないカードを出そうとした | ボタン無効化で防止 |
| 場が空でパスしようとした | メッセージ表示「場が空の時はパスできません」 |
| 手札が0枚になった | 勝利判定を実行 |
| ルームが見つからない | 404 を返し、クライアントは「ルームが存在しません」表示 |
| 人数上限超過 | 409 を返し、クライアントは「満員です」表示 |
| 無効なアクション（手番でない/手札にないカード） | 400 を返し、クライアントはトーストで理由表示 |
| 同時更新競合（ロック取得失敗） | 409 を返し、クライアントは再試行（自動） |

---

## 8. テスト項目

### 8.1 機能テスト

- [ ] カードが正しく配布される（各10枚）
- [ ] 先攻が正しく決定される
- [ ] カード選択・解除が正しく動作する
- [ ] 場より強いカードのみ出せる
- [ ] 同じ枚数のカードのみ出せる
- [ ] パスが正しく動作する
- [ ] 場流しが正しく動作する
- [ ] 革命が正しく発動・解除される
- [ ] 全コンボが正しく判定される
- [ ] コンボヒントが正しく表示される
- [ ] 勝敗判定が正しく行われる
- [ ] CPUが正しく思考・行動する

### 8.2 UIテスト

- [ ] 全アニメーションが正しく再生される
- [ ] レスポンシブ対応（320px〜1920px）
- [ ] タッチ操作が正しく動作する
- [ ] メッセージが正しく表示される

---

## 9. 変更履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0.0 | 2025-01-27 | 初版作成 |